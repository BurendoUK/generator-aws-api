function die (){
  echo "$1" 1>&2
  exit 1
}

echo "Started running $(basename "$0")"

echo "> Installing gitlab runner"
curl -LJO https://gitlab-runner-downloads.s3.amazonaws.com/v15.1.0/deb/gitlab-runner_amd64.deb
sudo dpkg -i gitlab-runner_amd64.deb

# Work around for "No such file or directory" error when cloning repos
# https://gitlab.com/gitlab-org/gitlab-runner/-/issues/4845
sudo mv /home/gitlab-runner/.bash_logout /home/gitlab-runner/.bash_logout.bak

echo "> Installing gitlab runner service overrides"
sudo mkdir /etc/systemd/system/gitlab-runner.service.d
sudo mv /tmp/gitlab-runner.service.overrides /etc/systemd/system/gitlab-runner.service.d/override.conf

echo "> Configure AWS cli for gitlab runner service user"
sudo runuser -l gitlab-runner -c 'aws configure set default.region '$AWS_REGION''
sudo runuser -l gitlab-runner -c 'aws configure set default.output json'
sudo runuser -l gitlab-runner -c 'touch ~/.aws/credentials'

[ $? -ne 0 ] && die "Failed to install gitlab runner";

# Got this far? Then we are good
echo "Finished running $(basename "$0")"
exit 0;
